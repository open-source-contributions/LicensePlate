<?php

namespace PB\LicensePlate\Detector;
use PB\LicensePlate\Response\LicensePlateResponse;

/**
 * @author Philip Burggraf <philip@pburggraf.de>
 */
class GermanyDetector extends AbstractDetector
{
    protected $validDistricts = array(
        'AA' => array(),
        'ABG' => array(),
        'ABI' => array(),
        'AB' => array(),
        'AC' => array(),
        'AE' => array(),
        'AH' => array(),
        'AIB' => array(),
        'AIC' => array(),
        'AK' => array(),
        'ALF' => array(),
        'ALZ' => array(),
        'AM' => array(),
        'ANA' => array(),
        'ANG' => array(),
        'ANK' => array(),
        'AN' => array(),
        'APD' => array(),
        'AP' => array(),
        'ARN' => array(),
        'ART' => array(),
        'ASL' => array(),
        'ASZ' => array(),
        'AS' => array(),
        'AT' => array(),
        'AUR' => array(),
        'AU' => array(),
        'AW' => array(),
        'AZE' => array(),
        'AZ' => array(),
        'AÖ' => array(),
        'A' => array(),
        'BAD' => array(),
        'BAR' => array(),
        'BA' => array(),
        'BBG' => array(),
        'BB' => array(),
        'BCH' => array(),
        'BC' => array(),
        'BED' => array(),
        'BER' => array(),
        'BE' => array(),
        'BF' => array(),
        'BGL' => array(),
        'BH' => array(),
        'BID' => array(),
        'BIN' => array(),
        'BIR' => array(),
        'BIT' => array(),
        'BIW' => array(),
        'BI' => array(),
        'BKS' => array(),
        'BK' => array(),
        'BLB' => array(),
        'BLK' => array(),
        'BL' => array(),
        'BM' => array(),
        'BNA' => array(),
        'BN' => array(),
        'BOH' => array(),
        'BOR' => array(),
        'BOT' => array(),
        'BO' => array(),
        'BRA' => array(),
        'BRB' => array(),
        'BRG' => array(),
        'BRK' => array(),
        'BRL' => array(),
        'BRV' => array(),
        'BS' => array(),
        'BTF' => array(),
        'BT' => array(),
        'BUL' => array(),
        'BZ' => array(),
        'BÖ' => array(),
        'BÜD' => array(),
        'BÜR' => array(),
        'BÜS' => array(),
        'BÜZ' => array(),
        'B' => array(),
        'CAS' => array(),
        'CA' => array(),
        'CB' => array(),
        'CE' => array(),
        'CHA' => array(),
        'CLP' => array(),
        'CLZ' => array(),
        'COC' => array(),
        'COE' => array(),
        'CO' => array(),
        'CR' => array(),
        'CUX' => array(),
        'CW' => array(),
        'C' => array(),
        'DAH' => array(),
        'DAN' => array(),
        'DAU' => array(),
        'DA' => array(),
        'DBR' => array(),
        'DD' => array(),
        'DEG' => array(),
        'DEL' => array(),
        'DE' => array(),
        'DGF' => array(),
        'DH' => array(),
        'DIL' => array(),
        'DIN' => array(),
        'DIZ' => array(),
        'DI' => array(),
        'DKB' => array(),
        'DLG' => array(),
        'DL' => array(),
        'DM' => array(),
        'DN' => array(),
        'DON' => array(),
        'DO' => array(),
        'DUD' => array(),
        'DU' => array(),
        'DW' => array(),
        'DZ' => array(),
        'DÜW' => array(),
        'D' => array(),
        'EA' => array(),
        'EBE' => array(),
        'EBN' => array(),
        'EBS' => array(),
        'EB' => array(),
        'ECK' => array(),
        'ED' => array(),
        'EE' => array(),
        'EF' => array(),
        'EG' => array(),
        'EIC' => array(),
        'EIL' => array(),
        'EIN' => array(),
        'EIS' => array(),
        'EI' => array(),
        'EL' => array(),
        'EMD' => array(),
        'EMS' => array(),
        'EM' => array(),
        'EN' => array(),
        'ERB' => array(),
        'ERH' => array(),
        'ERK' => array(),
        'ERZ' => array(),
        'ER' => array(),
        'ESB' => array(),
        'ESW' => array(),
        'ES' => array(),
        'EU' => array(),
        'EW' => array(),
        'E' => array(),
        'FB' => array(),
        'FDB' => array(),
        'FDS' => array(),
        'FD' => array(),
        'FEU' => array(),
        'FFB' => array(),
        'FF' => array(),
        'FG' => array(),
        'FI' => array(),
        'FKB' => array(),
        'FLÖ' => array(),
        'FL' => array(),
        'FN' => array(),
        'FOR' => array(),
        'FO' => array(),
        'FRG' => array(),
        'FRI' => array(),
        'FRW' => array(),
        'FR' => array(),
        'FS' => array(),
        'FTL' => array(),
        'FT' => array(),
        'FZ' => array(),
        'FÜS' => array(),
        'FÜ' => array(),
        'F' => array(),
        'GAN' => array(),
        'GAP' => array(),
        'GA' => array(),
        'GC' => array(),
        'GDB' => array(),
        'GD' => array(),
        'GEO' => array(),
        'GER' => array(),
        'GE' => array(),
        'GF' => array(),
        'GG' => array(),
        'GHA' => array(),
        'GHC' => array(),
        'GI' => array(),
        'GK' => array(),
        'GLA' => array(),
        'GL' => array(),
        'GMN' => array(),
        'GM' => array(),
        'GNT' => array(),
        'GN' => array(),
        'GOA' => array(),
        'GOH' => array(),
        'GP' => array(),
        'GRA' => array(),
        'GRH' => array(),
        'GRI' => array(),
        'GRM' => array(),
        'GRZ' => array(),
        'GR' => array(),
        'GS' => array(),
        'GTH' => array(),
        'GT' => array(),
        'GUB' => array(),
        'GUN' => array(),
        'GVM' => array(),
        'GV' => array(),
        'GW' => array(),
        'GZ' => array(),
        'GÖ' => array(),
        'GÜ' => array(),
        'G' => array(),
        'HAB' => array(),
        'HAL' => array(),
        'HAM' => array(),
        'HAS' => array(),
        'HA' => array(),
        'HBN' => array(),
        'HBS' => array(),
        'HB' => array(),
        'HCH' => array(),
        'HC' => array(),
        'HDH' => array(),
        'HDL' => array(),
        'HD' => array(),
        'HEB' => array(),
        'HEF' => array(),
        'HEI' => array(),
        'HER' => array(),
        'HET' => array(),
        'HE' => array(),
        'HF' => array(),
        'HGN' => array(),
        'HGW' => array(),
        'HG' => array(),
        'HHM' => array(),
        'HH' => array(),
        'HIG' => array(),
        'HIP' => array(),
        'HI' => array(),
        'HK' => array(),
        'HL' => array(),
        'HMÜ' => array(),
        'HM' => array(),
        'HN' => array(),
        'HOG' => array(),
        'HOH' => array(),
        'HOL' => array(),
        'HOM' => array(),
        'HOR' => array(),
        'HOT' => array(),
        'HO' => array(),
        'HP' => array(),
        'HRO' => array(),
        'HR' => array(),
        'HSK' => array(),
        'HST' => array(),
        'HS' => array(),
        'HU' => array(),
        'HVL' => array(),
        'HV' => array(),
        'HWI' => array(),
        'HX' => array(),
        'HY' => array(),
        'HZ' => array(),
        'HÖS' => array(),
        'H' => array(),
        'IGB' => array(),
        'IK' => array(),
        'ILL' => array(),
        'IL' => array(),
        'IN' => array(),
        'IZ' => array(),
        'JE' => array(),
        'JL' => array(),
        'JÜL' => array(),
        'J' => array(),
        'KA' => array(),
        'KB' => array(),
        'KC' => array(),
        'KEH' => array(),
        'KEL' => array(),
        'KEM' => array(),
        'KE' => array(),
        'KF' => array(),
        'KG' => array(),
        'KH' => array(),
        'KIB' => array(),
        'KI' => array(),
        'KK' => array(),
        'KLE' => array(),
        'KLZ' => array(),
        'KL' => array(),
        'KM' => array(),
        'KN' => array(),
        'KRU' => array(),
        'KR' => array(),
        'KS' => array(),
        'KT' => array(),
        'KUS' => array(),
        'KU' => array(),
        'KW' => array(),
        'KYF' => array(),
        'KY' => array(),
        'KÖN' => array(),
        'KÖT' => array(),
        'KÖZ' => array(),
        'KÜN' => array(),
        'K' => array(),
        'LAU' => array(),
        'LA' => array(),
        'LBS' => array(),
        'LBZ' => array(),
        'LB' => array(),
        'LC' => array(),
        'LDK' => array(),
        'LDS' => array(),
        'LD' => array(),
        'LEO' => array(),
        'LER' => array(),
        'LEV' => array(),
        'LG' => array(),
        'LH' => array(),
        'LIB' => array(),
        'LIF' => array(),
        'LIP' => array(),
        'LI' => array(),
        'LL' => array(),
        'LM' => array(),
        'LN' => array(),
        'LOS' => array(),
        'LP' => array(),
        'LRO' => array(),
        'LR' => array(),
        'LSZ' => array(),
        'LUP' => array(),
        'LU' => array(),
        'LWL' => array(),
        'LÖB' => array(),
        'LÖ' => array(),
        'LÜN' => array(),
        'L' => array(),
        'MAB' => array(),
        'MAI' => array(),
        'MAK' => array(),
        'MAL' => array(),
        'MA' => array(),
        'MB' => array(),
        'MC' => array(),
        'MD' => array(),
        'MED' => array(),
        'MEG' => array(),
        'MEI' => array(),
        'MEK' => array(),
        'MER' => array(),
        'MET' => array(),
        'ME' => array(),
        'MGH' => array(),
        'MGN' => array(),
        'MG' => array(),
        'MHL' => array(),
        'MH' => array(),
        'MIL' => array(),
        'MI' => array(),
        'MKK' => array(),
        'MK' => array(),
        'ML' => array(),
        'MM' => array(),
        'MN' => array(),
        'MOD' => array(),
        'MOL' => array(),
        'MON' => array(),
        'MOS' => array(),
        'MO' => array(),
        'MQ' => array(),
        'MR' => array(),
        'MSE' => array(),
        'MSH' => array(),
        'MSP' => array(),
        'MST' => array(),
        'MS' => array(),
        'MTK' => array(),
        'MTL' => array(),
        'MW' => array(),
        'MYK' => array(),
        'MY' => array(),
        'MZG' => array(),
        'MZ' => array(),
        'MÜB' => array(),
        'MÜR' => array(),
        'MÜ' => array(),
        'M' => array(),
        'NAB' => array(),
        'NAI' => array(),
        'NAU' => array(),
        'NB' => array(),
        'NDH' => array(),
        'ND' => array(),
        'NEA' => array(),
        'NEB' => array(),
        'NEC' => array(),
        'NEN' => array(),
        'NES' => array(),
        'NEW' => array(),
        'NE' => array(),
        'NF' => array(),
        'NH' => array(),
        'NI' => array(),
        'NK' => array(),
        'NMB' => array(),
        'NMS' => array(),
        'NM' => array(),
        'NOH' => array(),
        'NOL' => array(),
        'NOM' => array(),
        'NOR' => array(),
        'NP' => array(),
        'NR' => array(),
        'NT' => array(),
        'NU' => array(),
        'NVP' => array(),
        'NWM' => array(),
        'NW' => array(),
        'NY' => array(),
        'NZ' => array(),
        'NÖ' => array(),
        'N' => array(),
        'OAL' => array(),
        'OA' => array(),
        'OBG' => array(),
        'OB' => array(),
        'OCH' => array(),
        'OC' => array(),
        'OD' => array(),
        'OE' => array(),
        'OF' => array(),
        'OG' => array(),
        'OHA' => array(),
        'OHV' => array(),
        'OHZ' => array(),
        'OH' => array(),
        'OK' => array(),
        'OL' => array(),
        'OPR' => array(),
        'OP' => array(),
        'OSL' => array(),
        'OS' => array(),
        'OVI' => array(),
        'OVL' => array(),
        'OZ' => array(),
        'PAF' => array(),
        'PAN' => array(),
        'PAR' => array(),
        'PA' => array(),
        'PB' => array(),
        'PCH' => array(),
        'PEG' => array(),
        'PE' => array(),
        'PF' => array(),
        'PIR' => array(),
        'PI' => array(),
        'PLÖ' => array(),
        'PL' => array(),
        'PM' => array(),
        'PN' => array(),
        'PRÜ' => array(),
        'PR' => array(),
        'PS' => array(),
        'PW' => array(),
        'PZ' => array(),
        'P' => array(),
        'QFT' => array(),
        'QLB' => array(),
        'RA' => array(),
        'RC' => array(),
        'RDG' => array(),
        'RD' => array(),
        'REG' => array(),
        'REH' => array(),
        'RE' => array(),
        'RG' => array(),
        'RH' => array(),
        'RID' => array(),
        'RIE' => array(),
        'RI' => array(),
        'RL' => array(),
        'RM' => array(),
        'RN' => array(),
        'ROD' => array(),
        'ROF' => array(),
        'ROK' => array(),
        'ROL' => array(),
        'ROS' => array(),
        'ROT' => array(),
        'ROW' => array(),
        'RO' => array(),
        'RP' => array(),
        'RSL' => array(),
        'RS' => array(),
        'RT' => array(),
        'RU' => array(),
        'RV' => array(),
        'RW' => array(),
        'RZ' => array(),
        'RÜD' => array(),
        'RÜG' => array(),
        'R' => array(),
        'SAB' => array(),
        'SAD' => array(),
        'SAN' => array(),
        'SAW' => array(),
        'SBG' => array(),
        'SBK' => array(),
        'SB' => array(),
        'SCZ' => array(),
        'SC' => array(),
        'SDH' => array(),
        'SDL' => array(),
        'SDT' => array(),
        'SEB' => array(),
        'SEE' => array(),
        'SEF' => array(),
        'SEL' => array(),
        'SE' => array(),
        'SFB' => array(),
        'SFT' => array(),
        'SGH' => array(),
        'SG' => array(),
        'SHA' => array(),
        'SHG' => array(),
        'SHK' => array(),
        'SHL' => array(),
        'SIG' => array(),
        'SIM' => array(),
        'SI' => array(),
        'SK' => array(),
        'SLE' => array(),
        'SLF' => array(),
        'SLK' => array(),
        'SLN' => array(),
        'SLS' => array(),
        'SLZ' => array(),
        'SLÜ' => array(),
        'SL' => array(),
        'SM' => array(),
        'SN' => array(),
        'SOB' => array(),
        'SOG' => array(),
        'SOK' => array(),
        'SON' => array(),
        'SO' => array(),
        'SPB' => array(),
        'SPN' => array(),
        'SP' => array(),
        'SRB' => array(),
        'SRO' => array(),
        'SR' => array(),
        'STA' => array(),
        'STB' => array(),
        'STD' => array(),
        'STE' => array(),
        'STL' => array(),
        'ST' => array(),
        'SUL' => array(),
        'SU' => array(),
        'SWA' => array(),
        'SW' => array(),
        'SZB' => array(),
        'SZ' => array(),
        'SÖM' => array(),
        'SÜW' => array(),
        'S' => array(),
        'TBB' => array(),
        'TDO' => array(),
        'TET' => array(),
        'TE' => array(),
        'TF' => array(),
        'TG' => array(),
        'TIR' => array(),
        'TO' => array(),
        'TP' => array(),
        'TR' => array(),
        'TS' => array(),
        'TUT' => array(),
        'TÖL' => array(),
        'TÜ' => array(),
        'UEM' => array(),
        'UE' => array(),
        'UFF' => array(),
        'UH' => array(),
        'UL' => array(),
        'UM' => array(),
        'UN' => array(),
        'USI' => array(),
        'VAI' => array(),
        'VB' => array(),
        'VEC' => array(),
        'VER' => array(),
        'VG' => array(),
        'VIB' => array(),
        'VIE' => array(),
        'VK' => array(),
        'VOH' => array(),
        'VR' => array(),
        'VS' => array(),
        'V' => array(),
        'WAF' => array(),
        'WAK' => array(),
        'WAN' => array(),
        'WAT' => array(),
        'WA' => array(),
        'WBS' => array(),
        'WB' => array(),
        'WDA' => array(),
        'WEL' => array(),
        'WEN' => array(),
        'WER' => array(),
        'WES' => array(),
        'WE' => array(),
        'WF' => array(),
        'WHV' => array(),
        'WIL' => array(),
        'WIS' => array(),
        'WIT' => array(),
        'WIZ' => array(),
        'WI' => array(),
        'WK' => array(),
        'WLG' => array(),
        'WL' => array(),
        'WMS' => array(),
        'WM' => array(),
        'WND' => array(),
        'WN' => array(),
        'WOB' => array(),
        'WOH' => array(),
        'WOL' => array(),
        'WOR' => array(),
        'WOS' => array(),
        'WO' => array(),
        'WRN' => array(),
        'WR' => array(),
        'WSF' => array(),
        'WST' => array(),
        'WSW' => array(),
        'WS' => array(),
        'WTM' => array(),
        'WT' => array(),
        'WUG' => array(),
        'WUN' => array(),
        'WUR' => array(),
        'WW' => array(),
        'WZL' => array(),
        'WZ' => array(),
        'WÜM' => array(),
        'WÜ' => array(),
        'W' => array(),
        'ZEL' => array(),
        'ZE' => array(),
        'ZIG' => array(),
        'ZI' => array(),
        'ZP' => array(),
        'ZR' => array(),
        'ZW' => array(),
        'ZZ' => array(),
        'Z' => array(),
        'ÖHR' => array(),
    );

    /**
     * @param string $licensePlate
     *
     * @return bool
     */
    public function validate($licensePlate)
    {
        return $this->details($licensePlate)->isValid();
    }

    /**
     * @param string $licensePlate
     * 
     * @return LicensePlateResponse
     */
    public function details($licensePlate)
    {
        $licensePlate = $this->normalize($licensePlate);
        
        $response = new LicensePlateResponse($licensePlate);

        // match default plate layout (inclusive historic)
        if (preg_match('/^[A-ZÄÖÜ]{1,3} [A-Z]{1,2} [0-9]{1,4}[H]?$/', $licensePlate) === 1) {
            $plateParts = $this->seperate($licensePlate);

            // check if the frist block is a valid german district
            if (array_key_exists($plateParts[0], $this->validDistricts)){
                $response->setIsValid(true);

                // it is not possible to have 3 characters in the first block combined with 2 characters and 4 numbers
                if (strlen($plateParts[0]) == 3 && strlen($plateParts[1]) == 2 && strlen($plateParts[2]) > 3) {
                    $response->setIsValid(false);
                }
            }
        }

        // match gov. plate layout
        if (preg_match('/^[0-9]{1,2} [0-9]{1,2}$/', $licensePlate) === 1) {
            $response->setIsValid(true);
        }

        // match plates of the diplomatic corps
        if (preg_match('/^(?:(?:0|B|BN) [0-9]{2,3} [0-9]{1,3}[A-Z]?|[A-Z]{1,3} 9[0-9]{2,4}[A-Z]?)$/', $licensePlate) === 1) {
            $response->setIsValid(true);
        }

        // match fed. plate layout
        if (preg_match('/^B[P|D|W] [0-9]{1,2} [0-9]{1,4}$/', $licensePlate) === 1) {
            $response->setIsValid(true);
        }

        // match local police cars
        if (preg_match('/^(?:(?:NRW|BWL|BBL|RPL|SAL) (?:[4-6]{1}? )[0-9]{1,4}|(?:B|LSA|SH) [0-9]{1,5}|(?:HB|HH) [0-9]{1,4}|MVL 3[0-9]{1,4}|(?:WI HP|DD Q|EF LP) [0-9]{1,4})$/', $licensePlate) === 1) {
            $response->setIsValid(true);
        }

        // match military plate layout
        if (preg_match('/^Y (?:[0-9]{1,4} [0-9]{1,4}|[0-9]{1,6})$/', $licensePlate) === 1) {
            $response->setIsValid(true);
        }
        
        return $response;
    }
}